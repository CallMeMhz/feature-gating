{% extends "base.html" %}

{% block content %}
<div x-data="appState()" x-init="init()" @beforeunload.window="handleBeforeUnload($event)" class="h-screen flex">
    <!-- 左侧导航栏 -->
    <div class="w-64 bg-gray-800 text-white flex flex-col">
        <div class="p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold">{{ app_title }}</h1>
        </div>
        
        <!-- Projects 列表 -->
        <div class="flex-1 overflow-y-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-sm font-semibold text-gray-400 uppercase">Projects</h2>
                <button @click="showNewProjectModal = true" class="text-blue-400 hover:text-blue-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
            </div>
            
            <div id="projects-list">
                {% if user %}
                <template x-if="projects.length === 0">
                    <div class="text-gray-400 text-sm">暂无项目</div>
                </template>
                <template x-for="project in projects" :key="project.id">
                    <div 
                        @click="selectProject(project)"
                        class="p-3 mb-2 rounded cursor-pointer hover:bg-gray-700 transition"
                        :class="{'bg-gray-700': currentProject && currentProject.id === project.id}"
                    >
                        <div class="font-medium" x-text="project.name"></div>
                        <div class="text-xs text-gray-400" x-text="'by ' + project.created_by"></div>
                    </div>
                </template>
                {% else %}
                <div class="text-gray-400 text-sm">请先<a href="/login" class="text-blue-400 hover:underline">登录</a></div>
                {% endif %}
            </div>
        </div>
        
        <!-- 底部用户信息 -->
        <div class="p-4 border-t border-gray-700">
            {% if user %}
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm font-medium">{{ user.username }}</div>
                    <div class="text-xs text-gray-400">{{ user.role }}</div>
                </div>
                <button hx-post="/api/auth/logout" hx-swap="none" @click="setTimeout(() => window.location.href='/login', 100)" class="text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
            {% else %}
            <a href="/login" class="block text-center py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded">
                登录
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- 中间主区域 -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <div class="bg-white border-b border-gray-200 p-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold" x-text="currentProject ? currentProject.name : '选择一个项目'"></h2>
                <button 
                    x-show="currentProject" 
                    @click="addNewItem()"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                    + 新增 Item
                </button>
            </div>
        </div>
        
        <!-- 调试栏 -->
        <div x-show="currentProject" class="bg-gray-50 border-b border-gray-200 px-4 py-2">
            <div class="flex flex-wrap items-center gap-2">
                <span class="text-xs font-medium text-gray-400 shrink-0">调试</span>
                <input 
                    type="text" 
                    x-model="debugUserId"
                    @keyup.enter="runDebugCheck()"
                    placeholder="user_id"
                    class="flex-1 min-w-[100px] max-w-[200px] px-2 py-1 text-sm bg-white border border-gray-300 rounded focus:outline-none focus:border-blue-400"
                >
                <input 
                    type="text" 
                    x-model="debugChatId"
                    @keyup.enter="runDebugCheck()"
                    placeholder="chat_id"
                    class="flex-1 min-w-[100px] max-w-[200px] px-2 py-1 text-sm bg-white border border-gray-300 rounded focus:outline-none focus:border-blue-400"
                >
                <input 
                    type="text" 
                    x-model="debugEmail"
                    @keyup.enter="runDebugCheck()"
                    placeholder="email"
                    class="flex-1 min-w-[100px] max-w-[200px] px-2 py-1 text-sm bg-white border border-gray-300 rounded focus:outline-none focus:border-blue-400"
                >
                <button 
                    @click="runDebugCheck()"
                    :disabled="debugLoading || (!debugUserId && !debugChatId && !debugEmail)"
                    class="px-3 py-1 text-xs rounded shrink-0 transition"
                    :class="(!debugLoading && (debugUserId || debugChatId || debugEmail)) ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-200 text-gray-400 cursor-not-allowed'"
                >
                    <template x-if="debugLoading">
                        <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </template>
                    <span x-show="!debugLoading">检测</span>
                </button>
                <template x-if="Object.keys(debugResults).length > 0">
                    <span class="text-xs text-gray-500 shrink-0">
                        <span class="font-medium text-emerald-600" x-text="Object.values(debugResults).filter(v => v).length"></span>/<span x-text="Object.keys(debugResults).length"></span>
                    </span>
                </template>
                <button 
                    x-show="debugUserId || debugChatId || debugEmail || Object.keys(debugResults).length > 0"
                    @click="clearDebug()"
                    class="text-xs text-gray-400 hover:text-gray-600 shrink-0"
                >
                    清除
                </button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <template x-if="!currentProject">
                <div class="text-gray-500 text-center py-12">
                    <p>请从左侧选择一个项目</p>
                </div>
            </template>
            
            <template x-if="currentProject && items.length === 0">
                <div class="text-gray-500 text-center py-12">
                    <p>暂无 Items，点击右上角添加</p>
                </div>
            </template>
            
            <!-- 响应式 Grid: 最小宽度 320px，自动填充 -->
            <div class="grid gap-4 pb-8" style="grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));">
                <template x-for="(item, index) in items" :key="index">
                    <div 
                        class="shadow-sm border border-gray-200 relative"
                        :class="{
                            'opacity-40': isItemHit(item.name) === false
                        }"
                        :style="isItemHit(item.name) === true ? 'outline: 3px solid #22c55e;' : ''"
                    >
                        <!-- 未保存提示条 -->
                        <div 
                            x-show="isItemModified(index) || isItemNew(index)"
                            class="bg-amber-400 text-amber-900 text-xs font-medium px-3 py-1 text-center rounded-t-lg"
                            x-text="isItemNew(index) ? '新增' : '未保存'"
                        ></div>
                        <div class="p-4 bg-white rounded-b-lg">
                            {% include 'components/item_card.html' %}
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <!-- 右侧边栏 - 调整为 w-64 -->
    <div class="w-64 bg-white border-l border-gray-200 flex flex-col" x-show="currentProject">
        <div class="p-4 border-b border-gray-200">
            <h3 class="font-semibold text-lg">操作</h3>
        </div>
        
        <!-- 操作按钮 -->
        <div class="p-4 space-y-2 border-b border-gray-200">
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">备注（可选）</label>
                <input 
                    type="text" 
                    x-model="snapshotRemark"
                    placeholder="输入本次更改的备注..."
                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                >
            </div>
            <button 
                @click="saveChanges()"
                :disabled="!hasUnsavedChanges"
                class="w-full py-2 px-4 rounded text-sm font-medium transition"
                :class="hasUnsavedChanges ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
            >
                保存更改
            </button>
            <button 
                @click="cancelChanges()"
                :disabled="!hasUnsavedChanges"
                class="w-full py-2 px-4 rounded text-sm transition"
                :class="hasUnsavedChanges ? 'bg-gray-200 text-gray-800 hover:bg-gray-300' : 'bg-gray-100 text-gray-400 cursor-not-allowed'"
            >
                取消
            </button>
        </div>
        
        <!-- 历史记录 -->
        <div class="flex-1 overflow-y-auto p-4">
            <h4 class="text-sm font-semibold text-gray-600 mb-2">历史记录</h4>
            <div id="snapshots-list">
                <div class="text-gray-400 text-xs">暂无历史记录</div>
            </div>
        </div>
    </div>
    
    <!-- 新建项目模态框 -->
    <div x-show="showNewProjectModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96" @click.away="showNewProjectModal = false">
            <h3 class="text-lg font-semibold mb-4">新建项目</h3>
            <input 
                type="text" 
                x-model="newProjectName"
                @keyup.enter="if (newProjectName.trim()) createProject()"
                placeholder="项目名称"
                class="w-full px-3 py-2 border border-gray-300 rounded mb-4"
            >
            <div class="flex justify-end space-x-2">
                <button @click="showNewProjectModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                <button 
                    @click="createProject()" 
                    :disabled="!newProjectName.trim()"
                    :class="newProjectName.trim() ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                    class="px-4 py-2 rounded transition-colors"
                >创建</button>
            </div>
        </div>
    </div>
</div>

<script>
function appState() {
    return {
        currentProject: null,
        items: [],
        originalItems: [],
        hasUnsavedChanges: false,
        showNewProjectModal: false,
        newProjectName: '',
        projects: [],
        snapshotRemark: '',
        // 调试相关
        debugUserId: '',
        debugChatId: '',
        debugEmail: '',
        debugResults: {},
        debugLoading: false,
        
        init() {
            // 如果已登录，加载项目列表
            {% if user %}
            this.loadProjects();
            {% endif %}
        },
        
        async loadProjects() {
            try {
                const response = await fetch('/api/projects');
                if (response.ok) {
                    this.projects = await response.json();
                }
            } catch (e) {
                console.error('加载项目失败:', e);
            }
        },
        
        selectProject(project) {
            if (this.hasUnsavedChanges) {
                if (!confirm('有未保存的更改，确定要切换项目吗？')) {
                    return;
                }
            }
            this.currentProject = project;
            this.items = JSON.parse(JSON.stringify(project.items || []));
            this.originalItems = JSON.parse(JSON.stringify(project.items || []));
            this.hasUnsavedChanges = false;
            this.debugResults = {}; // 清空调试结果
            this.loadSnapshots();
        },
        
        async runDebugCheck() {
            if (!this.currentProject || (!this.debugUserId && !this.debugChatId && !this.debugEmail)) return;
            
            // 过滤有效的 items
            const validItems = this.items.filter(item => item.name && item.name.trim());
            if (validItems.length === 0) return;
            
            this.debugLoading = true;
            this.debugResults = {};
            
            try {
                // 使用 debug 接口，发送当前编辑中的 draft 配置
                const response = await fetch('/api/fg/debug', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        items: validItems.map(item => ({
                            name: item.name,
                            enabled: item.enabled,
                            conditions: item.conditions || [],
                            condition_groups: item.condition_groups || []
                        })),
                        user_id: this.debugUserId || null,
                        chat_id: this.debugChatId || null,
                        email: this.debugEmail || null
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.debugResults = data.results;
                }
            } catch (e) {
                console.error('检测失败:', e);
            } finally {
                this.debugLoading = false;
            }
        },
        
        clearDebugResults() {
            this.debugResults = {};
        },
        
        clearDebug() {
            this.debugUserId = '';
            this.debugChatId = '';
            this.debugEmail = '';
            this.debugResults = {};
        },
        
        isItemHit(itemName) {
            if (!itemName || Object.keys(this.debugResults).length === 0) return null;
            const key = itemName.toLowerCase();
            // 检查是否在结果中（key 大小写不敏感匹配）
            for (const [k, v] of Object.entries(this.debugResults)) {
                if (k.toLowerCase() === key) return v;
            }
            return null;
        },
        
        isItemModified(index) {
            // 如果是新增的 item，不算修改
            if (index >= this.originalItems.length) return false;
            // 比较当前 item 和原始 item
            const current = JSON.stringify(this.items[index]);
            const original = JSON.stringify(this.originalItems[index]);
            return current !== original;
        },
        
        isItemNew(index) {
            return index >= this.originalItems.length;
        },
        
        async loadSnapshots() {
            if (!this.currentProject) return;
            
            const response = await fetch(`/api/snapshots?project_id=${this.currentProject.id}`);
            if (response.ok) {
                const snapshots = await response.json();
                this.renderSnapshots(snapshots);
            }
        },
        
        renderSnapshots(snapshots) {
            const container = document.getElementById('snapshots-list');
            if (snapshots.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-xs">暂无历史记录</div>';
                return;
            }
            
            container.innerHTML = snapshots.map(s => `
                <div class="mb-2 p-2 bg-gray-50 rounded text-xs">
                    <div class="font-medium">${s.updated_by}</div>
                    <div class="text-gray-500">${new Date(s.updated_at).toLocaleString()}</div>
                    ${s.remark ? `<div class="mt-1">${s.remark}</div>` : ''}
                    <button onclick="viewSnapshot('${s.id}')" class="text-blue-600 mt-1">查看</button>
                </div>
            `).join('');
        },
        
        addNewItem() {
            this.items.push({
                name: '',
                description: '',
                enabled: true,
                value: '',
                conditions: []
            });
            this.hasUnsavedChanges = true;
        },
        
        isValidKeyFormat(name) {
            if (!name || !name.trim()) return false;
            // 允许：小写字母、数字、中划线(-)、下划线(_)、点号(.)、井号(#)、美元符号($)、@ 符号
            const regex = /^[a-z0-9_.\-#$@]+$/;
            return regex.test(name.trim());
        },
        
        isDuplicateName(name, currentIndex) {
            if (!name || !name.trim()) return false;
            const trimmedName = name.trim().toLowerCase();
            return this.items.some((item, idx) => 
                idx !== currentIndex && item.name.trim().toLowerCase() === trimmedName
            );
        },
        
        hasDuplicateNames() {
            const names = this.items
                .map(item => item.name.trim().toLowerCase())
                .filter(name => name !== '');
            return names.length !== new Set(names).size;
        },
        
        hasInvalidKeyFormat() {
            return this.items.some(item => !this.isValidKeyFormat(item.name));
        },
        
        async saveChanges() {
            // 检查是否有空的 Key
            const hasEmptyName = this.items.some(item => !item.name || !item.name.trim());
            if (hasEmptyName) {
                window.toastManager.show('存在空的 Key，请填写完整后再保存！', 'error');
                return;
            }
            
            // 检查 Key 格式
            if (this.hasInvalidKeyFormat()) {
                window.toastManager.show('Key 格式不正确，只能包含小写字母、数字、-_.$#@！', 'error');
                return;
            }
            
            // 检查是否有重复的 Key（大小写不敏感）
            if (this.hasDuplicateNames()) {
                window.toastManager.show('存在重复的 Key（大小写不敏感），请修改后再保存！', 'error');
                return;
            }
            
            try {
                // 更新项目（包括 items）
                const response = await fetch(`/api/projects/${this.currentProject.id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({items: this.items})
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '保存失败');
                }
                
                // 创建快照
                await fetch('/api/snapshots', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project_id: this.currentProject.id,
                        remark: this.snapshotRemark.trim() || ''
                    })
                });
                
                this.hasUnsavedChanges = false;
                this.originalItems = JSON.parse(JSON.stringify(this.items));
                this.snapshotRemark = ''; // 清空备注输入框
                
                // 重新加载项目以获取最新状态
                await this.loadProjects();
                this.currentProject = this.projects.find(p => p.id === this.currentProject.id);
                await this.loadSnapshots();
                
                window.toastManager.show('保存成功！', 'success');
            } catch (e) {
                window.toastManager.show('保存失败: ' + e.message, 'error');
            }
        },
        
        cancelChanges() {
            if (confirm('确定要取消更改吗？')) {
                this.items = JSON.parse(JSON.stringify(this.originalItems));
                this.hasUnsavedChanges = false;
            }
        },
        
        async createProject() {
            if (!this.newProjectName.trim()) return;
            
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: this.newProjectName})
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    window.toastManager.show(error.detail || '创建失败', 'error');
                    return;
                }
                
                this.showNewProjectModal = false;
                this.newProjectName = '';
                
                // 重新加载项目列表
                await this.loadProjects();
                
                window.toastManager.show('项目创建成功！', 'success');
            } catch (e) {
                window.toastManager.show('创建失败: ' + e.message, 'error');
            }
        },
        
        handleBeforeUnload(event) {
            if (this.hasUnsavedChanges) {
                event.preventDefault();
                event.returnValue = '';
            }
        },
        
        // 不再需要 escapeHtml，Alpine 自动处理了
    }
}

// 查看快照的全局函数
async function viewSnapshot(snapshotId) {
    const response = await fetch(`/api/snapshots/${snapshotId}`);
    if (response.ok) {
        const snapshot = await response.json();
        const win = window.open('', '_blank');
        win.document.write(`<pre>${snapshot.yaml}</pre>`);
    }
}
</script>
{% endblock %}
